<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Test robot</title>
<link rel="stylesheet" href="./../../asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="article">
<div id="header">
<h1>Test robot</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of contents</div>
<ul class="sectlevel1">
<li><a href="#_mainboard">Mainboard</a>
<ul class="sectlevel2">
<li><a href="#_nucleo_modifications">NUCLEO modifications</a></li>
<li><a href="#_firmware">Firmware</a></li>
</ul>
</li>
<li><a href="#_wheel_motor_driver">Wheel motor driver</a></li>
<li><a href="#_wiring">Wiring</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_mainboard">Mainboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/ReikoR/pwir21-NUCLEO-adapter">Altium Designer project</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ReikoR/pwir21-NUCLEO-adapter/blob/master/pwir21-NUCLEO-adapter-panel.PDF">Schematic and PCB drawing PDF</a></p>
</div>
<div class="sect2">
<h3 id="_nucleo_modifications">NUCLEO modifications</h3>
<div class="paragraph">
<p>There are jumper resistors and solder pads on the NUCLEO board that are used to connect some microcontroller pins to pin headers.
Firmware uses some pins differently from the default jumper configuration.
Necessary modifications are shown in <a href="#image_nucleo_jumpers">Figure 1</a>.
0 ohm resistors marked as SB2 and SB3 should be removed and jumper pads marked as 8 and 11 should be soldered together.
Alternatively SB2 and SB3 resistors can be soldered onto jumper pads 8 and 11.</p>
</div>
<div id="image_nucleo_jumpers" class="imageblock">
<div class="content">
<img src="../images/test_robot_nucleo_jumper_modifications.svg" alt="test robot nucleo jumper modifications" width="300">
</div>
<div class="title">Figure 1. NUCLEO jumper modifications</div>
</div>
</div>
<div class="sect2">
<h3 id="_firmware">Firmware</h3>
<div class="sect3">
<h4 id="_version_history">Version history</h4>
<div class="paragraph">
<p><strong>v1.0.0</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Initial implementation of 3 wheel motor and 1 thrower motor speed control.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>v1.1.0</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Added failsafe to stop all motors when no commands have been received for 0.5 seconds.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_binary_firmware_file">Binary firmware file</h4>
<div class="paragraph">
<p><a href="https://github.com/ReikoR/picr21-basketball-robot-guide/raw/master/source/electronics/picr21-NUCLEO-adapter-firmware_v1_1_0.bin">picr21-NUCLEO-adapter-firmware_v1_1_0.bin</a></p>
</div>
<div class="paragraph">
<p>Connect NUCLEO to a computer and drag or copy the *.bin file on the NOD_G431KB drive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_commands_to_mainboard">Sending commands to mainboard</h4>
<div class="paragraph">
<p>Struct in firmware</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct __attribute__((packed)) Command {
  int16_t speed1;
  int16_t speed2;
  int16_t speed3;
  uint16_t throwerSpeed;
  uint8_t disableFailsafe; // 1 to disable failsafe, anything else to enable
  uint16_t delimiter;
} Command;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using with python&#8217;s <a href="https://docs.python.org/3/library/struct.html">struct library</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">disable_failsafe = 0

struct.pack('&lt;hhhHBH', speed1, speed2, speed3, thrower_speed, disable_failsafe, 0xAAAA)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_receiving_data_from_mainboard">Receiving data from mainboard</h4>
<div class="paragraph">
<p>Struct in firmware</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct Feedback {
  int16_t speed1;
  int16_t speed2;
  int16_t speed3;
  uint16_t delimiter;
} Feedback;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using with python&#8217;s <a href="https://docs.python.org/3/library/struct.html">struct library</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">actual_speed1, actual_speed2, actual_speed3, feedback_delimiter = struct.unpack('&lt;hhhH', received_data)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_thrower_speeds">Thrower speeds</h4>
<div class="paragraph">
<p>Thrower speeds are sent to thrower motor controller using
<a href="https://dmrlawson.co.uk/index.php/2017/12/04/dshot-in-the-dark/">DShot protocol</a>.
Speed values are between 48 - 2047 for 0 to 100% speed.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wheel_motor_driver">Wheel motor driver</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://digilabor.ut.ee/index.php/MC33886_driver_board">Wiki page</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ReikoR/MC33886_driver_board">Altium Designer project</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ReikoR/MC33886_driver_board/blob/master/MC33886_driver_board.PDF">Schematic PDF</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wiring">Wiring</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="../images/nucleo_mainboard_wiring.svg" alt="nucleo mainboard wiring"></span></p>
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>